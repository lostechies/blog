---
wordpress_id: 28
title: Dynamic Loading of .Net Assemblies
date: 2009-08-31T22:29:00+00:00
author: Ryan Svihla
layout: post
wordpress_guid: /blogs/rssvihla/archive/2009/08/31/dynamic-loading-of-net-assemblies.aspx
dsq_thread_id:
  - "425624292"
categories:
  - AppDomain
  - DotNet
  - Hate
redirect_from: "/blogs/rssvihla/archive/2009/08/31/dynamic-loading-of-net-assemblies.aspx/"
---
Problem: You have dependencies which can be in a number of directories outside of the directory your app is running in. DotNet AppDomains are heavy to say the least and very high in ceremony.&#160; You do not want to deal with secondary app domain creation.

Solution: Override&#160; AssemblyResolve event on your current app domain.

&#160;</p> 

<div style="padding-bottom: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;float: none;padding-top: 0px" class="wlWriterEditableSmartContent">
  <div style="font-family:consolas,lucida console,courier,monospace">
    &#160;&#160;&#160;&#160;<span style="color:#0000ff">public</span>&#160;<span style="color:#0000ff">class</span>&#160;<span style="color:#2b91af">AppDomainLoader</span>&#160;:&#160;IAppDomainLoader<br /> &#160;&#160;&#160;&#160;<span style="color:#0000ff">{</span><br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;<br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">private</span>&#160;ResolveEventHandler&#160;_searchAssemblyMethod&#160;=&#160;_searchDir;<br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">public</span>&#160;ResolveEventHandler&#160;FindAssemblyMethod<br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">{</span><br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">set</span>&#160;<span style="color:#0000ff">{</span>&#160;_searchAssemblyMethod&#160;=&#160;<span style="color:#0000ff">value</span>;&#160;<span style="color:#0000ff">}</span><br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">}</span><br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">private</span>&#160;<span style="color:#0000ff">static</span>&#160;<span style="color:#2b91af">string</span>[]&#160;_directoriesToSearch;<br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">private</span>&#160;&#160;<span style="color:#0000ff">static</span>&#160;Assembly&#160;_searchDir(Object&#160;o,&#160;ResolveEventArgs&#160;e)<br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">{</span><br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">foreach</span>&#160;(var&#160;s&#160;<span style="color:#0000ff">in</span>&#160;_directoriesToSearch)<br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">{</span><br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;var&#160;filetoload&#160;=&#160;s&#160;+&#160;&#160;e.Name.Split(<span style="color:#a31515">&#8216;,&#8217;</span>)[0]&#160;+&#160;<span style="color:#a31515">&#8220;.dll&#8221;</span>;&#160;<span style="color:#008000">//bad&#160;one&#160;liner&#160;that&#160;parses&#160;the&#160;first&#160;part&#160;of&#160;the&#160;assembly&#160;name&#160;and&#160;adds&#160;.dll&#160;at&#160;the&#160;end<br /> </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">if</span>&#160;(File.Exists(filetoload))&#160;<span style="color:#008000">//sees&#160;if&#160;the&#160;file&#160;is&#160;even&#160;in&#160;the&#160;directory<br /> </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">{</span><br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">return</span>&#160;Assembly.LoadFrom(filetoload);&#160;&#160;<span style="color:#008000">//returns&#160;assembly&#160;once&#160;found,&#160;a&#160;bit&#160;naive&#160;and&#160;does&#160;not&#160;handle&#160;version&#160;conflicts&#160;well.<br /> </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">}</span><br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">}</span><br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">return</span>&#160;<span style="color:#0000ff">null</span>;<br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">}</span><br /> &#160;&#160;&#160;&#160;&#160;<br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">public</span>&#160;<span style="color:#0000ff">void</span>&#160;Search(<span style="color:#2b91af">string</span>[]&#160;directoriesToSearch)<br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">{</span><br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;_directoriesToSearch&#160;=&#160;directoriesToSearch;&#160;<span style="color:#008000">//sets&#160;directories&#160;to&#160;search&#160;to&#160;allow&#160;entry&#160;point&#160;for&#160;dynamic&#160;searching<br /> </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;AppDomain.CurrentDomain.AssemblyResolve&#160;-=&#160;_searchAssemblyMethod;&#160;<span style="color:#008000">//cleans&#160;up&#160;previous&#160;events,&#160;may&#160;not&#160;be&#160;needed.<br /> </span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;AppDomain.CurrentDomain.AssemblyResolve&#160;+=&#160;_searchAssemblyMethod;&#160;<span style="color:#008000">//registered&#160;the&#160;event<br /> </span><br /> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style="color:#0000ff">}</span><br /> &#160;&#160;&#160;&#160;<span style="color:#0000ff">}</span>
  </div>
</div>

Now whenever there is a missing Assembly, the _searchAssemblyMethod will be fired,&#160; and all directories given to the Search method will attempt to find an assembly with the matching name.