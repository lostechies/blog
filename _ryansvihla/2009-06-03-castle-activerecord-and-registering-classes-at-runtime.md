---
wordpress_id: 10
title: Castle ActiveRecord and registering classes at runtime
date: 2009-06-03T06:02:00+00:00
author: Ryan Svihla
layout: post
wordpress_guid: /blogs/rssvihla/archive/2009/06/03/castle-activerecord-and-registering-classes-at-runtime.aspx
dsq_thread_id:
  - "1078364741"
categories:
  - ActiveRecord
  - Castle
  - NHibernate
  - ORM
redirect_from: "/blogs/rssvihla/archive/2009/06/03/castle-activerecord-and-registering-classes-at-runtime.aspx/"
---
{% raw %}
I use the following trick for adding ActiveRecord classes after the fact for our in-house plug-in architecture.&nbsp; Thanks to whichever blogger/mailing list I picked this up from so long ago.

### Scenario 1: Class(es) to load inherit from same base class as current running ActiveRecord classes

&nbsp;

<pre><span style="background: #f8f8f8"> </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">var </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">holder </span><span style="background: #f8f8f8">= </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">ActiveRecordMediator</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">GetSessionFactoryHolder</span><span style="background: #f8f8f8">();<br />            </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">ActiveRecordStarter</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">RegisterTypes</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">typeof</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">Employee</span><span style="background: #f8f8f8">), </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">typeof</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">Customer</span><span style="background: #f8f8f8">)); </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: green">//register your subclasses here<br />            </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">holder</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">RegisterSessionFactory</span><span style="background: #f8f8f8">(<br />                </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">holder</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">GetConfiguration</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">typeof</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">ActiveRecordBase</span><span style="background: #f8f8f8">)).</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">BuildSessionFactory</span><span style="background: #f8f8f8">(), </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">typeof</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">ActiveRecordBase</span><span style="background: #f8f8f8">)<br />                );</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: green">//reloads session factory without this types will not be registered. I believe this is actually a "feature" in Castle trunk. may be fixed now.</span></pre>

[](http://11011.net/software/vspaste)[](http://11011.net/software/vspaste)[](http://11011.net/software/vspaste)

> 
[](http://11011.net/software/vspaste)&nbsp;This is all you need to register extra classes that are accessing the same database as the application is using.

### Scenario 2:&nbsp; Not only must the new types be registered but a new base class with its new configuration as well

<pre><span style="background: #f8f8f8">  </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">InPlaceConfigurationSource </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">source </span><span style="background: #f8f8f8">= </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">new </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">InPlaceConfigurationSource</span><span style="background: #f8f8f8">();<br />            </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">Dictionary</span><span style="background: #f8f8f8">&lt;</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">string</span><span style="background: #f8f8f8">, </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">string</span><span style="background: #f8f8f8">&gt; </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">confdict </span><span style="background: #f8f8f8">= </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">new </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">Dictionary</span><span style="background: #f8f8f8">&lt;</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">string</span><span style="background: #f8f8f8">, </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">string</span><span style="background: #f8f8f8">&gt; </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: green">// config. change this to suite your needs<br />                                                  </span><span style="background: #f8f8f8">{{</span><span style="background: #ffffe6">"connection.driver_class"</span><span style="background: #f8f8f8">, </span><span style="background: #ffffe6">"NHibernate.Driver.SqlClientDriver"</span><span style="background: #f8f8f8">},<br />                                                  {</span><span style="background: #ffffe6">"dialect"</span><span style="background: #f8f8f8">    ,</span><span style="background: #ffffe6">"NHibernate.Dialect.MsSql2000Dialect"</span><span style="background: #f8f8f8">},<br />                                                  {</span><span style="background: #ffffe6">"connection.provider"</span><span style="background: #f8f8f8">,</span><span style="background: #ffffe6">"NHibernate.Connection.DriverConnectionProvider"</span><span style="background: #f8f8f8">},<br />                                                  {</span><span style="background: #ffffe6">"connection.connection_string"</span><span style="background: #f8f8f8">,</span><span style="background: #ffffe6">"Data Source=localhost;Initial Catalog=intranet_devel;Integrated Security=SSPI"</span><span style="background: #f8f8f8">},<br />                                                  {</span><span style="background: #ffffe6">"proxyfactory.factory_class"</span><span style="background: #f8f8f8">,</span><span style="background: #ffffe6">"NHibernate.ByteCode.Castle.ProxyFactoryFactory, NHibernate.ByteCode.Castle"</span><span style="background: #f8f8f8">}<br />                                                  };<br />            </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">source</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">Add</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">typeof</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">BaseCRMobj</span><span style="background: #f8f8f8">), </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">confdict</span><span style="background: #f8f8f8">);<br />            </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">var </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">holder </span><span style="background: #f8f8f8">= </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">ActiveRecordMediator</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">GetSessionFactoryHolder</span><span style="background: #f8f8f8">();<br />            </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">var </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">config </span><span style="background: #f8f8f8">= </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">new </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">Configuration</span><span style="background: #f8f8f8">(); <br />            </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">foreach </span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">var </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">conf </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">in </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">source</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">GetConfiguration</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">typeof</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">BaseCRMobj</span><span style="background: #f8f8f8">)).</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">Children</span><span style="background: #f8f8f8">) </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: green">//turns ActiveRecord config Configuration could be skipped if you load Configuration object instead<br />            </span><span style="background: #f8f8f8">{<br />                </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">config</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">Properties</span><span style="background: #f8f8f8">[</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">conf</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">Name</span><span style="background: #f8f8f8">] = </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">conf</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">Value</span><span style="background: #f8f8f8">;<br />            }<br />            </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">holder</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">Register</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">typeof</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">BaseCRMobj</span><span style="background: #f8f8f8">), </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">config</span><span style="background: #f8f8f8">); </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: green">// loads the base type and its configuration into ActiveRecord<br />            </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">holder</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">RegisterSessionFactory</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">holder</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">GetConfiguration</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">typeof</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">BaseCRMobj</span><span style="background: #f8f8f8">)).</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">BuildSessionFactory</span><span style="background: #f8f8f8">(), </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">typeof</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">BaseCRMobj</span><span style="background: #f8f8f8">)); </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: green">//reloads sessionfactory again note not using ActiveRecordBase now</span></pre>

[](http://11011.net/software/vspaste)

<pre>&nbsp;</pre>

<pre>After you have configured the base type for your ActiveRecord classes plus its connection string then call the register types method again:</pre>

<pre>&nbsp;</pre>

<pre><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">var </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">holder </span><span style="background: #f8f8f8">= </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">ActiveRecordMediator</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">GetSessionFactoryHolder</span><span style="background: #f8f8f8">();<br />            </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">ActiveRecordStarter</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">RegisterTypes</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">typeof</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">Employee</span><span style="background: #f8f8f8">), </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">typeof</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">Customer</span><span style="background: #f8f8f8">)); </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: green">// register individual subclasses<br />            </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">holder</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">RegisterSessionFactory</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">holder</span><span style="background: #f8f8f8">.</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">GetConfiguration</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">typeof</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">BaseCRMobj</span><span style="background: #f8f8f8">)).</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: maroon">BuildSessionFactory</span><span style="background: #f8f8f8">(), </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: navy">typeof</span><span style="background: #f8f8f8">(</span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: #a65300">BaseCRMobj</span><span style="background: #f8f8f8">)); </span><span style="background: #f8f8f8 none repeat scroll 0% 0%;color: green">//reloads instance of SessionFactory</span></pre>

[](http://11011.net/software/vspaste)[](http://11011.net/software/vspaste)

&nbsp;

Overall this works quite well even if its noisy . I&rsquo;m able to dynamically load connections to 5 different databases and register a hundred or so classes total, all after the application has started. The real code has some DRY cleanup going on but this is more or less what I really use. &nbsp;&nbsp;
{% endraw %}
