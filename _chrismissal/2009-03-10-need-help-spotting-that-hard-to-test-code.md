---
id: 3346
title: Need Help Spotting that Hard to Test Code?
date: 2009-03-10T06:13:00+00:00
author: Chris Missal
layout: post
guid: /blogs/chrismissal/archive/2009/03/10/need-help-spotting-that-hard-to-test-code.aspx
dsq_thread_id:
  - "262174854"
categories:
  - Best Practices
  - Design Principles
  - SOLID
  - Testing
---
I&rsquo;m a big fan of <a href="http://www.iunknown.com/2007/06/vibrant_ink_vis.html" target="_blank">Jon Lam&#8217;s Vibrant Ink Visual Studio theme</a>. Here&rsquo;s why: If you look at the syntax highlighting in the following code, you&rsquo;ll see some yellow text. In this theme, or any any other theme that does it well, you&rsquo;ll notice class names stand out a bit on their own. Referencing a class name means you&rsquo;re probably either creating a new object or referencing a static function or property. Both of these make for hard to test code. Code that is hard to test is brittle. Apply <a href="http://en.wikipedia.org/wiki/Murphy%27s_law" target="_blank">Murphy&rsquo;s Law</a> and you&rsquo;re in trouble.

<pre style="background: black;font-size:120%"><span style="background: black none repeat scroll 0% 0%;color: #ff8000">public class </span><span style="background: black none repeat scroll 0% 0%;color: yellow">CustomerNotifier<br /></span><span style="background: black none repeat scroll 0% 0%;color: white">{<br />    </span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">private readonly </span><span style="background: black none repeat scroll 0% 0%;color: yellow">EmailService </span><span style="background: black none repeat scroll 0% 0%;color: white">emailService;<br /><br />    </span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">public </span><span style="background: black none repeat scroll 0% 0%;color: white">CustomerNotifier()<br />    {<br />        emailService = </span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">new </span><span style="background: black none repeat scroll 0% 0%;color: yellow">EmailService</span><span style="background: black none repeat scroll 0% 0%;color: white">();<br />    }<br /><br />    </span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">public void </span><span style="background: black none repeat scroll 0% 0%;color: white">SendNotification(</span><span style="background: black none repeat scroll 0% 0%;color: #2b91af">IUser </span><span style="background: black none repeat scroll 0% 0%;color: white">user, </span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">string </span><span style="background: black none repeat scroll 0% 0%;color: white">subjectText, </span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">string </span><span style="background: black none repeat scroll 0% 0%;color: white">messageText)<br />    {<br />        </span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">if</span><span style="background: black none repeat scroll 0% 0%;color: white">(user.Subscriptions().Contains(</span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">this</span><span style="background: black none repeat scroll 0% 0%;color: white">))<br />        {<br />            </span><span style="background: black none repeat scroll 0% 0%;color: yellow">MailMessage </span><span style="background: black none repeat scroll 0% 0%;color: white">mailMessage = </span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">new </span><span style="background: black none repeat scroll 0% 0%;color: yellow">MailMessage</span><span style="background: black none repeat scroll 0% 0%;color: white">(</span><span style="background: black none repeat scroll 0% 0%;color: lime">"customerService@company.com"</span><span style="background: black none repeat scroll 0% 0%;color: white">, <br />                user.Email, subjectText, messageText);<br />            emailService.SendTo(user, mailMessage);<br />        }<br />    }<br />}<br /></span></pre>

[](http://11011.net/software/vspaste)

If I want to test whether the SendTo message was called on the email service when the instance is contained in the user&rsquo;s subscriptions and NOT called when the user isn&rsquo;t subscribed to it. I can&rsquo;t really think of a good way to do so.

### Time to Redo This a Bit

My theme settings are telling me that EmailService and MailMessage should be abstracted. This is because they&rsquo;re &ldquo;yellow&rdquo;. Not really the reason, but those are what I see as flags for improvement. Instead of newing-up a MailMessage, I&rsquo;m going to create my own abstraction. I&rsquo;m also going to <a href="http://martinfowler.com/articles/injection.html" target="_blank">inject the EmailService</a> (as an abstraction) into the constructor. Later on, we can make assertions on it using a <a href="http://ayende.com/projects/rhino-mocks.aspx" target="_blank">mocked object</a>.

<pre style="background: black;font-size:120%"><span style="background: black none repeat scroll 0% 0%;color: #ff8000">public class </span><span style="background: black none repeat scroll 0% 0%;color: yellow">CustomerNotifier<br /></span><span style="background: black none repeat scroll 0% 0%;color: white">{<br />    </span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">private readonly </span><span style="background: black none repeat scroll 0% 0%;color: #2b91af">IEmailService </span><span style="background: black none repeat scroll 0% 0%;color: white">emailService;<br /><br />    </span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">public </span><span style="background: black none repeat scroll 0% 0%;color: white">CustomerNotifier(</span><span style="background: black none repeat scroll 0% 0%;color: #2b91af">IEmailService </span><span style="background: black none repeat scroll 0% 0%;color: white">emailService)<br />    {<br />        </span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">this</span><span style="background: black none repeat scroll 0% 0%;color: white">.emailService = emailService;<br />    }<br /><br />    </span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">public void </span><span style="background: black none repeat scroll 0% 0%;color: white">SendNotification(</span><span style="background: black none repeat scroll 0% 0%;color: #2b91af">IUser </span><span style="background: black none repeat scroll 0% 0%;color: white">user, </span><span style="background: black none repeat scroll 0% 0%;color: #2b91af">IMailMessage </span><span style="background: black none repeat scroll 0% 0%;color: white">mailMessage)<br />    {<br />        </span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">if</span><span style="background: black none repeat scroll 0% 0%;color: white">(user.Subscriptions().Contains(</span><span style="background: black none repeat scroll 0% 0%;color: #ff8000">this</span><span style="background: black none repeat scroll 0% 0%;color: white">))<br />        {<br />            mailMessage.From = </span><span style="background: black none repeat scroll 0% 0%;color: lime">"customerService@company.com"</span><span style="background: black none repeat scroll 0% 0%;color: white">;<br />            emailService.SendTo(user, mailMessage);<br />        }<br />    }<br />}<br /></span></pre>

[](http://11011.net/software/vspaste)

This helps me quickly identify areas of my code that seem to be designed poorly. When I see a lot of whatever color my class names are, I see areas that can be improved. This code is much easier to test now.